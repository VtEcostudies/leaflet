<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>VCE Example: Leaflet with iNat Occ API data and BISON WMS Raster Overlay</title>

    <meta name="description" content="VCE Example: Leaflet with BISON WMS Occurrence Data Raster Overlay">
    <meta name="author" content="Vermont Center for Ecostudies">

    <link href="css/bootstrap.min.css" rel="stylesheet">

    <link rel="SHORTCUT ICON" href="https://vtecostudies.org/wp-content/themes/vtecostudies/favicon.ico"/>

    <!-- Leaflet's CSS -->
  	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
  		integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
  		crossorigin=""/>

  	<!-- Make sure you put this AFTER Leaflet's CSS -->
  	<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
  	  integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
  	  crossorigin=""></script>

    <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.js"></script>

    <script src="js/moment.min.js"></script>
    <!--
    <script type="module" src="js/inat_leaflet.js"></script>
    -->

  </head>
  <body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-1"></div>
            <div class="col-md-10">
                <h5 class="vceCenter"><u>VCE Example: Leaflet with iNat Occ API data</u></h5>
            </div>
            <div class="col-md-1"></div>
        </div>
        <div class="row">
            <div class="col-md-1"></div>
            <div class="col-md-2">
                <a href="https://vtecostudies.org"><img src="img/vce_logo_small.png"/></a>
            </div>
            <div class="col-md-1">
                <label id=zoomLabel class="small vceOutline"></label>
            </div>
            <div class="col-md-7">
                <div class="row">
                    <label>Species Name: (</label>
                    <input type="radio" id="sciName" name="nameType" value="scientific_name"/><label for="sciName">Scientific</label>
                    <input type="radio" id="comName" name="nameType" value="common_name" checked><label for="comName">Common</label>
                    )
                    <input type="text" id="speciesName" size=40 value="Bicknell's thrush"/>
                    <input type="submit" id="speciesSubmit" value="Get Data"/>
                </div>
                <div class="row">
                    <label id=jsonResults class="small vceOutline"></label>
                </div>
            </div>
            <div class="col-md-1"></div>
        </div>
        <div class="row" id="standAlone">
            <div class="col-md-1"></div>
            <div class="col-md-10">
                <div id="mapid" style="width: 100%; height: 700px;" class="center"></div>
            </div>
            <div class="col-md-1"></div>
        </div>
        <div class="row">
            <div class="col-md-1"></div>
            <div class="col-md-10">
                <label id=apiUrlLabel class="small vceOutline"></label>
            </div>
            <div class="col-md-1"></div>
        </div>
        </div>
    </div>
  </form>

    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

  </body>
</html>
<script>

function getInatObs(begMsecs=0) {
  //var mapExt = getMapLlExtents();
  var baseUrl = 'https://api.inaturalist.org/v1/observations';
  //var begDate = `?d1=${getStamp(30)}`; // these are times but just need date with d1 call
  //var endDate = `&d2=${getStamp(0)}`;
  var begDate = `?created_d1=${getStamp(30)}`; // created_d1 needs time - added offset for UTC
  var endDate = `&created_d2=${getStamp(0)}`;  // see above
  var project = '&project_id=vermont-atlas-of-life';
  var place = '&place_id=47'; //Vermont
  var identified = '&current=true';
  //var bbox = `&nelat=${mapExt.nelat}&nelng=${mapExt.nelng}&swlat=${mapExt.swlat}&swlng=${mapExt.swlng}`;
  var order = '&order=desc&order_by=created_at';
  var iNatUrl = baseUrl + begDate + endDate + project + order;
  var iNatUrl = baseUrl + begDate + order;

  console.log('getInatObs', iNatUrl);
  //iNatUrl = 'https://api.inaturalist.org/v1/observations?project_id=vermont-atlas-of-life&d1=2022-01-01T12:00:00'
  // start a new chain of fetch events
  initOccRequest(iNatUrl);
}

function initOccRequest(url) {
    var occXHR = new XMLHttpRequest();
    occXHR.open("GET", url, true);

    //handle request responses here in this callback
    occXHR.onload = function() {
      var data = JSON.parse(this.response);
      if (request.status >= 200 && request.status < 400) {
          console.log('results:', data["total_results"]);
          occResults(this, url);
      } else {
          console.log('error');
      }
    };
    occXHR.send();

    //load the first page of data, which initiates subsequent page loads
    //loadPage(occXHR, url, 1);
}

/*
  loadPage - called initally by init, then recursively by results to load a series
  of pages of data until done or the user hits the 'Stop' button/
*/
function loadPage(occXHR, url, page) {
    occXHR.open("GET", url+`&page=${page}`, true);
    //occXHR.responseType = 'json';  //looks like you need to add this after the open, and use 'reponse' above, not 'responseText'
    //occXHR.setRequestHeader("Content-type", "application/json");
    //occXHR.setRequestHeader("Access-Control-Allow-Origin", "*");
    occXHR.send();
}

async function occResults(occXHR, url) {
    var jsonRes = occXHR.response; //JSON.parse(occXHR.response);
    var totr = jsonRes.total_results;
    var perp = jsonRes.per_page;
    var page = jsonRes.page;
    var pages = Math.floor(totr / perp) + ((totr % perp)>0?1:0);
    //await updateInatMap(jsonRes.results);
    if (page < pages && !stopData) {
      console.log(`occValMap::occResults calling loadPage for page ${page} of ${pages}`);
      loadPage(occXHR, url, ++page);
    } else {
      occXHR.abort(); //does this clean up memory?
    }
}

/* Time created at on iNat: "time_observed_at": "2022-01-07T15:24:58-05:00" 
 * I added -04:00 at the end of the string - should be -05:00 when we
 * have daylight savings 
 */
function getStamp(offsetSecs=30) {
  const stamp = moment(moment().valueOf() -  offsetSecs * 1000).format('YYYY-MM-DDTHH:mm:ss') + '-04:00';
  console.log('getStamp', stamp);
  return stamp;
}

//getInatObs();

</script>
